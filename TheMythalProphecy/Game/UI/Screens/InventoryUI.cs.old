using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using TheMythalProphecy.Game.UI.Components;
using System;
using System.Collections.Generic;

namespace TheMythalProphecy.Game.UI.Screens
{
    /// <summary>
    /// Inventory screen showing items in a grid with categories and actions.
    /// </summary>
    public class InventoryUI : UIWindow
    {
        private UIGrid _itemGrid;
        private UILabel _categoryLabel;
        private UILabel _itemNameLabel;
        private UILabel _itemDescriptionLabel;
        private UIButton _useButton;
        private UIButton _equipButton;
        private UIButton _discardButton;
        private UIButton _closeButton;

        private List<string> _categories;
        private int _currentCategoryIndex;

        public event Action<int> OnItemUsed;
        public event Action<int> OnItemEquipped;
        public event Action<int> OnItemDiscarded;

        public InventoryUI(int screenWidth, int screenHeight)
            : base(0, 0, 800, 600, "Inventory")
        {
            IsModal = true;
            Center(screenWidth, screenHeight);

            _categories = new List<string> { "All", "Consumables", "Equipment", "Key Items", "Materials" };
            _currentCategoryIndex = 0;

            BuildUI();
        }

        private void BuildUI()
        {
            var panel = ContentPanel;
            panel.LayoutMode = LayoutMode.Vertical;
            panel.Spacing = 10f;

            // Category label
            _categoryLabel = new UILabel(0, 0, 760, 30, "Category: All");
            panel.AddChild(_categoryLabel);

            // Item grid (left side)
            _itemGrid = new UIGrid(0, 0, 500, 400, columns: 5, cellWidth: 90, cellHeight: 90);
            _itemGrid.AllowSelection = true;
            _itemGrid.OnSelectionChanged += OnItemSelected;
            _itemGrid.OnItemActivated += OnItemActivated;
            panel.AddChild(_itemGrid);

            // Item details panel (right side)
            var detailsPanel = new UIPanel(520, 40, 240, 400);
            detailsPanel.LayoutMode = LayoutMode.Vertical;
            detailsPanel.Spacing = 10f;

            _itemNameLabel = new UILabel(0, 0, 220, 30, "");
            _itemNameLabel.TextColor = Color.Yellow;
            detailsPanel.AddChild(_itemNameLabel);

            _itemDescriptionLabel = new UILabel(0, 0, 220, 200, "");
            _itemDescriptionLabel.WrapText = true;
            detailsPanel.AddChild(_itemDescriptionLabel);

            // Action buttons
            _useButton = new UIButton(0, 0, 220, 40, "Use");
            _useButton.OnClick += () =>
            {
                if (_itemGrid.SelectedIndex >= 0)
                {
                    OnItemUsed?.Invoke(_itemGrid.SelectedIndex);
                }
            };
            detailsPanel.AddChild(_useButton);

            _equipButton = new UIButton(0, 0, 220, 40, "Equip");
            _equipButton.OnClick += () =>
            {
                if (_itemGrid.SelectedIndex >= 0)
                {
                    OnItemEquipped?.Invoke(_itemGrid.SelectedIndex);
                }
            };
            detailsPanel.AddChild(_equipButton);

            _discardButton = new UIButton(0, 0, 220, 40, "Discard");
            _discardButton.OnClick += () =>
            {
                if (_itemGrid.SelectedIndex >= 0)
                {
                    OnItemDiscarded?.Invoke(_itemGrid.SelectedIndex);
                }
            };
            detailsPanel.AddChild(_discardButton);

            panel.AddChild(detailsPanel);

            // Close button at bottom
            _closeButton = new UIButton(0, 0, 760, 40, "Close");
            _closeButton.OnClick += () => Close();
            panel.AddChild(_closeButton);
        }

        private void OnItemSelected(int index)
        {
            // Update item details when selection changes
            // This would be populated with actual item data
            _itemNameLabel.Text = $"Item {index}";
            _itemDescriptionLabel.Text = "Item description goes here. This is a placeholder for actual item data.";
        }

        private void OnItemActivated(int index)
        {
            // Default action when item is double-clicked/activated
            OnItemUsed?.Invoke(index);
        }

        public override void Update(GameTime gameTime)
        {
            base.Update(gameTime);

            // Handle category cycling with shoulder buttons
            var input = Core.GameServices.Input;
            if (IsVisible)
            {
                // L/R shoulder buttons or Q/E keys to cycle categories
                if (input.IsActionPressed("PreviousTab"))
                {
                    CycleCategoryPrevious();
                }
                else if (input.IsActionPressed("NextTab"))
                {
                    CycleCategoryNext();
                }

                if (input.IsActionPressed("Cancel"))
                {
                    Close();
                }
            }
        }

        public void AddItemSlot(UIElement itemSlot)
        {
            _itemGrid.AddItem(itemSlot);
        }

        public void ClearItems()
        {
            _itemGrid.ClearItems();
        }

        private void CycleCategoryNext()
        {
            _currentCategoryIndex = (_currentCategoryIndex + 1) % _categories.Count;
            UpdateCategoryLabel();
        }

        private void CycleCategoryPrevious()
        {
            _currentCategoryIndex--;
            if (_currentCategoryIndex < 0)
                _currentCategoryIndex = _categories.Count - 1;
            UpdateCategoryLabel();
        }

        private void UpdateCategoryLabel()
        {
            _categoryLabel.Text = $"Category: {_categories[_currentCategoryIndex]}";
        }
    }
}
