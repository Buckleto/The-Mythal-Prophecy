using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using TheMythalProphecy.Game.UI.Components;
using System;

namespace TheMythalProphecy.Game.UI.Screens
{
    /// <summary>
    /// Character status screen showing detailed stats, level, XP, and skills.
    /// </summary>
    public class StatusUI : UIWindow
    {
        private UILabel _characterNameLabel;
        private UILabel _classLabel;
        private UILabel _levelLabel;
        private UIProgressBar _xpBar;
        private UILabel _xpLabel;

        // Stats
        private UILabel _hpLabel;
        private UILabel _mpLabel;
        private UILabel _strengthLabel;
        private UILabel _defenseLabel;
        private UILabel _magicLabel;
        private UILabel _magicDefenseLabel;
        private UILabel _speedLabel;
        private UILabel _luckLabel;
        private UILabel _evasionLabel;
        private UILabel _criticalLabel;

        // Skills list
        private UIListBox _skillsList;
        private UILabel _skillDescriptionLabel;

        private UIButton _closeButton;

        public StatusUI(int screenWidth, int screenHeight)
            : base(0, 0, 800, 600, "Character Status")
        {
            IsModal = true;
            Center(screenWidth, screenHeight);

            BuildUI();
        }

        private void BuildUI()
        {
            var panel = ContentPanel;
            panel.LayoutMode = LayoutMode.Vertical;
            panel.Spacing = 10f;

            // Character header
            var headerPanel = new UIPanel(0, 0, 760, 100);
            headerPanel.LayoutMode = LayoutMode.Vertical;
            headerPanel.Spacing = 5f;

            _characterNameLabel = new UILabel(0, 0, 740, 30, "Hero");
            _characterNameLabel.TextColor = Color.Yellow;
            headerPanel.AddChild(_characterNameLabel);

            _classLabel = new UILabel(0, 0, 740, 25, "Class: Warrior");
            headerPanel.AddChild(_classLabel);

            _levelLabel = new UILabel(0, 0, 740, 25, "Level: 1");
            headerPanel.AddChild(_levelLabel);

            _xpBar = new UIProgressBar(0, 0, 740, 20);
            _xpBar.SetValue(0, 100);
            headerPanel.AddChild(_xpBar);

            _xpLabel = new UILabel(0, 0, 740, 20, "EXP: 0 / 100");
            _xpLabel.TextAlignment = TextAlignment.Center;
            headerPanel.AddChild(_xpLabel);

            panel.AddChild(headerPanel);

            // Main content area
            var contentRow = new UIPanel(0, 0, 760, 350);
            contentRow.LayoutMode = LayoutMode.Horizontal;
            contentRow.Spacing = 20f;

            // Stats panel (left)
            var statsPanel = new UIPanel(0, 0, 350, 350);
            statsPanel.LayoutMode = LayoutMode.Vertical;
            statsPanel.Spacing = 5f;

            var statsTitle = new UILabel(0, 0, 330, 30, "Statistics");
            statsTitle.TextColor = Color.LightBlue;
            statsPanel.AddChild(statsTitle);

            _hpLabel = CreateStatLabel("HP:", "100 / 100");
            _mpLabel = CreateStatLabel("MP:", "50 / 50");
            _strengthLabel = CreateStatLabel("Strength:", "10");
            _defenseLabel = CreateStatLabel("Defense:", "8");
            _magicLabel = CreateStatLabel("Magic:", "12");
            _magicDefenseLabel = CreateStatLabel("Magic Defense:", "7");
            _speedLabel = CreateStatLabel("Speed:", "15");
            _luckLabel = CreateStatLabel("Luck:", "5");
            _evasionLabel = CreateStatLabel("Evasion:", "10%");
            _criticalLabel = CreateStatLabel("Critical:", "5%");

            statsPanel.AddChild(_hpLabel);
            statsPanel.AddChild(_mpLabel);
            statsPanel.AddChild(_strengthLabel);
            statsPanel.AddChild(_defenseLabel);
            statsPanel.AddChild(_magicLabel);
            statsPanel.AddChild(_magicDefenseLabel);
            statsPanel.AddChild(_speedLabel);
            statsPanel.AddChild(_luckLabel);
            statsPanel.AddChild(_evasionLabel);
            statsPanel.AddChild(_criticalLabel);

            contentRow.AddChild(statsPanel);

            // Skills panel (right)
            var skillsPanel = new UIPanel(0, 0, 370, 350);
            skillsPanel.LayoutMode = LayoutMode.Vertical;
            skillsPanel.Spacing = 5f;

            var skillsTitle = new UILabel(0, 0, 350, 30, "Skills & Abilities");
            skillsTitle.TextColor = Color.LightGreen;
            skillsPanel.AddChild(skillsTitle);

            _skillsList = new UIListBox(0, 0, 350, 200);
            _skillsList.OnSelectionChanged += (index) => UpdateSkillDescription(index);
            skillsPanel.AddChild(_skillsList);

            _skillDescriptionLabel = new UILabel(0, 0, 350, 100, "Select a skill to view description.");
            _skillDescriptionLabel.WrapText = true;
            skillsPanel.AddChild(_skillDescriptionLabel);

            contentRow.AddChild(skillsPanel);

            panel.AddChild(contentRow);

            // Close button
            _closeButton = new UIButton(0, 0, 760, 40, "Close");
            _closeButton.OnClick += () => Close();
            panel.AddChild(_closeButton);
        }

        private UILabel CreateStatLabel(string statName, string value)
        {
            var label = new UILabel(0, 0, 330, 25, $"{statName,-18} {value}");
            return label;
        }

        private void UpdateSkillDescription(int index)
        {
            // Placeholder - would show actual skill description
            if (index >= 0)
            {
                _skillDescriptionLabel.Text = $"Description for skill at index {index}.";
            }
        }

        public override void Update(GameTime gameTime)
        {
            base.Update(gameTime);

            var input = Core.GameServices.Input;
            if (IsVisible && input.IsActionPressed("Cancel"))
            {
                Close();
            }
        }

        public void UpdateCharacterInfo(string name, string characterClass, int level, int currentXp, int xpToNext)
        {
            _characterNameLabel.Text = name;
            _classLabel.Text = $"Class: {characterClass}";
            _levelLabel.Text = $"Level: {level}";
            _xpBar.SetValue(currentXp, xpToNext);
            _xpLabel.Text = $"EXP: {currentXp} / {xpToNext}";
        }

        public void UpdateStats(int hp, int maxHp, int mp, int maxMp, int str, int def, int mag, int magDef, int spd, int luck, float evasion, float critical)
        {
            _hpLabel.Text = $"HP:               {hp} / {maxHp}";
            _mpLabel.Text = $"MP:               {mp} / {maxMp}";
            _strengthLabel.Text = $"Strength:         {str}";
            _defenseLabel.Text = $"Defense:          {def}";
            _magicLabel.Text = $"Magic:            {mag}";
            _magicDefenseLabel.Text = $"Magic Defense:    {magDef}";
            _speedLabel.Text = $"Speed:            {spd}";
            _luckLabel.Text = $"Luck:             {luck}";
            _evasionLabel.Text = $"Evasion:          {evasion:F1}%";
            _criticalLabel.Text = $"Critical:         {critical:F1}%";
        }

        public void AddSkill(string skillName)
        {
            _skillsList.AddItem(skillName);
        }

        public void ClearSkills()
        {
            _skillsList.ClearItems();
        }
    }
}
