using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using TheMythalProphecy.Game.UI.Components;
using System;

namespace TheMythalProphecy.Game.UI.Screens
{
    /// <summary>
    /// Party management screen for adding, removing, and reordering party members.
    /// </summary>
    public class PartyUI : UIWindow
    {
        private UIListBox _activePartyList;
        private UIListBox _reservePartyList;
        private UILabel _activePartyTitle;
        private UILabel _reservePartyTitle;
        private UIPanel _selectedMemberPanel;
        private UILabel _memberNameLabel;
        private UILabel _memberLevelLabel;
        private UILabel _memberClassLabel;
        private UILabel _memberHpLabel;
        private UILabel _memberMpLabel;

        private UIButton _addToPartyButton;
        private UIButton _removeFromPartyButton;
        private UIButton _moveUpButton;
        private UIButton _moveDownButton;
        private UIButton _closeButton;

        private bool _isSelectingActiveParty;

        public event Action<int, int> OnMemberSwapped; // (fromIndex, toIndex)
        public event Action<int> OnMemberAddedToParty;
        public event Action<int> OnMemberRemovedFromParty;

        public PartyUI(int screenWidth, int screenHeight)
            : base(0, 0, 900, 600, "Party Management")
        {
            IsModal = true;
            Center(screenWidth, screenHeight);
            _isSelectingActiveParty = true;

            BuildUI();
        }

        private void BuildUI()
        {
            var panel = ContentPanel;
            panel.LayoutMode = LayoutMode.Vertical;
            panel.Spacing = 10f;

            // Main content row
            var contentRow = new UIPanel(0, 0, 860, 400);
            contentRow.LayoutMode = LayoutMode.Horizontal;
            contentRow.Spacing = 20f;

            // Active party list (left)
            var activePartyPanel = new UIPanel(0, 0, 280, 400);
            activePartyPanel.LayoutMode = LayoutMode.Vertical;
            activePartyPanel.Spacing = 5f;

            _activePartyTitle = new UILabel(0, 0, 260, 30, "Active Party (Max 4)");
            _activePartyTitle.TextColor = Color.Yellow;
            activePartyPanel.AddChild(_activePartyTitle);

            _activePartyList = new UIListBox(0, 0, 260, 360);
            _activePartyList.OnSelectionChanged += (index) =>
            {
                _isSelectingActiveParty = true;
                UpdateMemberDetails(index, true);
            };
            activePartyPanel.AddChild(_activePartyList);

            contentRow.AddChild(activePartyPanel);

            // Member details (middle)
            _selectedMemberPanel = new UIPanel(0, 0, 280, 400);
            _selectedMemberPanel.LayoutMode = LayoutMode.Vertical;
            _selectedMemberPanel.Spacing = 10f;

            var detailsTitle = new UILabel(0, 0, 260, 30, "Member Details");
            detailsTitle.TextColor = Color.LightBlue;
            _selectedMemberPanel.AddChild(detailsTitle);

            _memberNameLabel = new UILabel(0, 0, 260, 30, "");
            _memberNameLabel.TextColor = Color.White;
            _selectedMemberPanel.AddChild(_memberNameLabel);

            _memberLevelLabel = new UILabel(0, 0, 260, 25, "");
            _selectedMemberPanel.AddChild(_memberLevelLabel);

            _memberClassLabel = new UILabel(0, 0, 260, 25, "");
            _selectedMemberPanel.AddChild(_memberClassLabel);

            _memberHpLabel = new UILabel(0, 0, 260, 25, "");
            _selectedMemberPanel.AddChild(_memberHpLabel);

            _memberMpLabel = new UILabel(0, 0, 260, 25, "");
            _selectedMemberPanel.AddChild(_memberMpLabel);

            contentRow.AddChild(_selectedMemberPanel);

            // Reserve party list (right)
            var reservePartyPanel = new UIPanel(0, 0, 280, 400);
            reservePartyPanel.LayoutMode = LayoutMode.Vertical;
            reservePartyPanel.Spacing = 5f;

            _reservePartyTitle = new UILabel(0, 0, 260, 30, "Reserve Party");
            _reservePartyTitle.TextColor = Color.LightGray;
            reservePartyPanel.AddChild(_reservePartyTitle);

            _reservePartyList = new UIListBox(0, 0, 260, 360);
            _reservePartyList.OnSelectionChanged += (index) =>
            {
                _isSelectingActiveParty = false;
                UpdateMemberDetails(index, false);
            };
            reservePartyPanel.AddChild(_reservePartyList);

            contentRow.AddChild(reservePartyPanel);

            panel.AddChild(contentRow);

            // Button row
            var buttonRow = new UIPanel(0, 0, 860, 50);
            buttonRow.LayoutMode = LayoutMode.Horizontal;
            buttonRow.Spacing = 10f;

            _addToPartyButton = new UIButton(0, 0, 150, 40, "Add to Party");
            _addToPartyButton.OnClick += () =>
            {
                if (!_isSelectingActiveParty && _reservePartyList.SelectedIndex >= 0)
                {
                    OnMemberAddedToParty?.Invoke(_reservePartyList.SelectedIndex);
                }
            };
            buttonRow.AddChild(_addToPartyButton);

            _removeFromPartyButton = new UIButton(0, 0, 180, 40, "Remove from Party");
            _removeFromPartyButton.OnClick += () =>
            {
                if (_isSelectingActiveParty && _activePartyList.SelectedIndex >= 0)
                {
                    OnMemberRemovedFromParty?.Invoke(_activePartyList.SelectedIndex);
                }
            };
            buttonRow.AddChild(_removeFromPartyButton);

            _moveUpButton = new UIButton(0, 0, 100, 40, "Move Up");
            _moveUpButton.OnClick += () => MoveUp();
            buttonRow.AddChild(_moveUpButton);

            _moveDownButton = new UIButton(0, 0, 120, 40, "Move Down");
            _moveDownButton.OnClick += () => MoveDown();
            buttonRow.AddChild(_moveDownButton);

            _closeButton = new UIButton(0, 0, 100, 40, "Close");
            _closeButton.OnClick += () => Close();
            buttonRow.AddChild(_closeButton);

            panel.AddChild(buttonRow);
        }

        private void UpdateMemberDetails(int index, bool isActiveParty)
        {
            // Placeholder - would show actual member data
            _memberNameLabel.Text = $"Member {index}";
            _memberLevelLabel.Text = "Level: 1";
            _memberClassLabel.Text = "Class: Warrior";
            _memberHpLabel.Text = "HP: 100 / 100";
            _memberMpLabel.Text = "MP: 50 / 50";
        }

        private void MoveUp()
        {
            if (!_isSelectingActiveParty) return;

            int index = _activePartyList.SelectedIndex;
            if (index > 0)
            {
                OnMemberSwapped?.Invoke(index, index - 1);
            }
        }

        private void MoveDown()
        {
            if (!_isSelectingActiveParty) return;

            int index = _activePartyList.SelectedIndex;
            if (index >= 0 && index < _activePartyList.ItemCount - 1)
            {
                OnMemberSwapped?.Invoke(index, index + 1);
            }
        }

        public override void Update(GameTime gameTime)
        {
            base.Update(gameTime);

            var input = Core.GameServices.Input;
            if (IsVisible && input.IsActionPressed("Cancel"))
            {
                Close();
            }
        }

        public void AddActivePartyMember(string memberInfo)
        {
            _activePartyList.AddItem(memberInfo);
        }

        public void AddReserveMember(string memberInfo)
        {
            _reservePartyList.AddItem(memberInfo);
        }

        public void ClearActiveParty()
        {
            _activePartyList.ClearItems();
        }

        public void ClearReserveParty()
        {
            _reservePartyList.ClearItems();
        }
    }
}
