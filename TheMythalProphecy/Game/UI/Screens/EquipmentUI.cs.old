using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using TheMythalProphecy.Game.UI.Components;
using System;

namespace TheMythalProphecy.Game.UI.Screens
{
    /// <summary>
    /// Equipment screen showing character equipment slots and stat comparisons.
    /// </summary>
    public class EquipmentUI : UIWindow
    {
        private UIPanel _characterPanel;
        private UIPanel _equipmentSlotsPanel;
        private UIPanel _statsPanel;
        private UILabel _characterNameLabel;
        private UILabel _characterLevelLabel;

        // Equipment slot labels
        private UILabel _weaponSlotLabel;
        private UILabel _armorSlotLabel;
        private UILabel _accessory1SlotLabel;
        private UILabel _accessory2SlotLabel;

        // Stats display
        private UILabel _hpLabel;
        private UILabel _mpLabel;
        private UILabel _strengthLabel;
        private UILabel _defenseLabel;
        private UILabel _magicLabel;
        private UILabel _magicDefenseLabel;
        private UILabel _speedLabel;
        private UILabel _luckLabel;

        private UIButton _changeEquipmentButton;
        private UIButton _optimizeButton;
        private UIButton _removeAllButton;
        private UIButton _closeButton;

        public event Action<string> OnChangeEquipment; // slot name
        public event Action OnOptimizeEquipment;
        public event Action OnRemoveAll;

        public EquipmentUI(int screenWidth, int screenHeight)
            : base(0, 0, 900, 600, "Equipment")
        {
            IsModal = true;
            Center(screenWidth, screenHeight);

            BuildUI();
        }

        private void BuildUI()
        {
            var panel = ContentPanel;
            panel.LayoutMode = LayoutMode.Vertical;
            panel.Spacing = 10f;

            // Top row: Character info and equipment slots
            var topRow = new UIPanel(0, 0, 860, 350);
            topRow.LayoutMode = LayoutMode.Horizontal;
            topRow.Spacing = 20f;

            // Character portrait/info (left)
            _characterPanel = new UIPanel(0, 0, 200, 350);
            _characterPanel.LayoutMode = LayoutMode.Vertical;
            _characterPanel.Spacing = 5f;

            _characterNameLabel = new UILabel(0, 0, 180, 30, "Hero");
            _characterNameLabel.TextColor = Color.Yellow;
            _characterPanel.AddChild(_characterNameLabel);

            _characterLevelLabel = new UILabel(0, 0, 180, 25, "Level 1");
            _characterPanel.AddChild(_characterLevelLabel);

            topRow.AddChild(_characterPanel);

            // Equipment slots (middle)
            _equipmentSlotsPanel = new UIPanel(0, 0, 320, 350);
            _equipmentSlotsPanel.LayoutMode = LayoutMode.Vertical;
            _equipmentSlotsPanel.Spacing = 10f;

            var slotsTitle = new UILabel(0, 0, 300, 30, "Equipment Slots");
            slotsTitle.TextColor = Color.LightBlue;
            _equipmentSlotsPanel.AddChild(slotsTitle);

            _weaponSlotLabel = CreateEquipmentSlot("Weapon:", "None");
            _armorSlotLabel = CreateEquipmentSlot("Armor:", "None");
            _accessory1SlotLabel = CreateEquipmentSlot("Accessory 1:", "None");
            _accessory2SlotLabel = CreateEquipmentSlot("Accessory 2:", "None");

            _equipmentSlotsPanel.AddChild(_weaponSlotLabel);
            _equipmentSlotsPanel.AddChild(_armorSlotLabel);
            _equipmentSlotsPanel.AddChild(_accessory1SlotLabel);
            _equipmentSlotsPanel.AddChild(_accessory2SlotLabel);

            topRow.AddChild(_equipmentSlotsPanel);

            // Stats (right)
            _statsPanel = new UIPanel(0, 0, 280, 350);
            _statsPanel.LayoutMode = LayoutMode.Vertical;
            _statsPanel.Spacing = 5f;

            var statsTitle = new UILabel(0, 0, 260, 30, "Stats");
            statsTitle.TextColor = Color.LightGreen;
            _statsPanel.AddChild(statsTitle);

            _hpLabel = CreateStatLabel("HP:", "100 / 100");
            _mpLabel = CreateStatLabel("MP:", "50 / 50");
            _strengthLabel = CreateStatLabel("Strength:", "10");
            _defenseLabel = CreateStatLabel("Defense:", "8");
            _magicLabel = CreateStatLabel("Magic:", "12");
            _magicDefenseLabel = CreateStatLabel("Mag Def:", "7");
            _speedLabel = CreateStatLabel("Speed:", "15");
            _luckLabel = CreateStatLabel("Luck:", "5");

            _statsPanel.AddChild(_hpLabel);
            _statsPanel.AddChild(_mpLabel);
            _statsPanel.AddChild(_strengthLabel);
            _statsPanel.AddChild(_defenseLabel);
            _statsPanel.AddChild(_magicLabel);
            _statsPanel.AddChild(_magicDefenseLabel);
            _statsPanel.AddChild(_speedLabel);
            _statsPanel.AddChild(_luckLabel);

            topRow.AddChild(_statsPanel);

            panel.AddChild(topRow);

            // Bottom row: Action buttons
            var buttonRow = new UIPanel(0, 0, 860, 50);
            buttonRow.LayoutMode = LayoutMode.Horizontal;
            buttonRow.Spacing = 10f;

            _changeEquipmentButton = new UIButton(0, 0, 200, 40, "Change Equipment");
            _changeEquipmentButton.OnClick += () => OnChangeEquipment?.Invoke("Weapon");
            buttonRow.AddChild(_changeEquipmentButton);

            _optimizeButton = new UIButton(0, 0, 150, 40, "Optimize");
            _optimizeButton.OnClick += () => OnOptimizeEquipment?.Invoke();
            buttonRow.AddChild(_optimizeButton);

            _removeAllButton = new UIButton(0, 0, 150, 40, "Remove All");
            _removeAllButton.OnClick += () => OnRemoveAll?.Invoke();
            buttonRow.AddChild(_removeAllButton);

            _closeButton = new UIButton(0, 0, 150, 40, "Close");
            _closeButton.OnClick += () => Close();
            buttonRow.AddChild(_closeButton);

            panel.AddChild(buttonRow);
        }

        private UILabel CreateEquipmentSlot(string slotName, string itemName)
        {
            var label = new UILabel(0, 0, 300, 25, $"{slotName,-15} {itemName}");
            return label;
        }

        private UILabel CreateStatLabel(string statName, string value)
        {
            var label = new UILabel(0, 0, 260, 25, $"{statName,-12} {value}");
            return label;
        }

        public override void Update(GameTime gameTime)
        {
            base.Update(gameTime);

            var input = Core.GameServices.Input;
            if (IsVisible && input.IsActionPressed("Cancel"))
            {
                Close();
            }
        }

        public void UpdateCharacterInfo(string name, int level)
        {
            _characterNameLabel.Text = name;
            _characterLevelLabel.Text = $"Level {level}";
        }

        public void UpdateEquipmentSlot(string slot, string itemName)
        {
            switch (slot.ToLower())
            {
                case "weapon":
                    _weaponSlotLabel.Text = $"Weapon:         {itemName}";
                    break;
                case "armor":
                    _armorSlotLabel.Text = $"Armor:          {itemName}";
                    break;
                case "accessory1":
                    _accessory1SlotLabel.Text = $"Accessory 1:    {itemName}";
                    break;
                case "accessory2":
                    _accessory2SlotLabel.Text = $"Accessory 2:    {itemName}";
                    break;
            }
        }

        public void UpdateStats(int hp, int maxHp, int mp, int maxMp, int str, int def, int mag, int magDef, int spd, int luck)
        {
            _hpLabel.Text = $"HP:          {hp} / {maxHp}";
            _mpLabel.Text = $"MP:          {mp} / {maxMp}";
            _strengthLabel.Text = $"Strength:    {str}";
            _defenseLabel.Text = $"Defense:     {def}";
            _magicLabel.Text = $"Magic:       {mag}";
            _magicDefenseLabel.Text = $"Mag Def:     {magDef}";
            _speedLabel.Text = $"Speed:       {spd}";
            _luckLabel.Text = $"Luck:        {luck}";
        }
    }
}
